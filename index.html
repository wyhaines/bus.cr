<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 1.0.0">
<meta name="crystal_docs.project_version" content="main">
<meta name="crystal_docs.project_name" content="bus">



<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/doc.js"></script>

  <meta name="repository-name" content="bus">
  <title>bus main</title>
  <script type="text/javascript">
  CrystalDocs.base_path = "";
  </script>
</head>
<body>

<svg class="hidden">
  <symbol id="octicon-link" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
  </symbol>
</svg>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="project-summary">
      <h1 class="project-name">
        <a href="index.html">
          bus
        </a>
      </h1>

      <span class="project-version">
        main
      </span>
    </div>
  </div>

  <div class="search-results hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="bus/Bus" data-name="bus">
      <a href="Bus.html">Bus</a>
      
        <ul>
  
  <li class=" " data-id="bus/Bus/Confidence" data-name="bus::confidence">
      <a href="Bus/Confidence.html">Confidence</a>
      
    </li>
  
  <li class=" " data-id="bus/Bus/Evaluation" data-name="bus::evaluation">
      <a href="Bus/Evaluation.html">Evaluation</a>
      
    </li>
  
  <li class=" " data-id="bus/Bus/Handler" data-name="bus::handler">
      <a href="Bus/Handler.html">Handler</a>
      
    </li>
  
  <li class="parent " data-id="bus/Bus/Message" data-name="bus::message">
      <a href="Bus/Message.html">Message</a>
      
        <ul>
  
  <li class=" " data-id="bus/Bus/Message/Strategy" data-name="bus::message::strategy">
      <a href="Bus/Message/Strategy.html">Strategy</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="bus/Bus/Pipeline" data-name="bus::pipeline(t)">
      <a href="Bus/Pipeline.html">Pipeline</a>
      
    </li>
  
  <li class=" " data-id="bus/Bus/Version" data-name="bus::version">
      <a href="Bus/Version.html">Version</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<h1><a id="bus" class="anchor" href="#bus">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>bus</h1>

<p><img src="https://img.shields.io/github/workflow/status/wyhaines/bus.cr/bus.cr%20CI?style=for-the-badge&logo=GitHub" alt="Bus.cr CI"/>
<a href="https://github.com/wyhaines/bus.cr/releases"><img src="https://img.shields.io/github/release/wyhaines/bus.cr.svg?style=for-the-badge" alt="GitHub release"/></a>
<img src="https://img.shields.io/github/commits-since/wyhaines/bus.cr/latest?style=for-the-badge" alt="GitHub commits since latest release (by SemVer)"/></p>

<p>This class implements an in-process pubsub style message bus.</p>

<p>The bus receives messages and routes them to all interested handlers. Additionally, the bus is capable of dispatching the message to only a subset of potential handlers, based on a best-fit, or to all eligible handlers.</p>

<h2><a id="handler-selection-winner-selection-protocol" class="anchor" href="#handler-selection-winner-selection-protocol">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Handler Selection & Winner Selection Protocol</h2>

<p>Imagine that there are multiple subscribers for a given type of message (a given tag), but the message being dispatched should only be handled by a single subscriber. This implementation puts the responsibility on each handler to respond to an "evaluate" request on a message on two axex.</p>

<p>The first axis is relevance, which is a measure of how appropriate the subject of the message is to the purpose of the handler. For example, an HTTP request might be highly relevant to both a static asset handler and an API endpoint, and not at all relevant to a handler that proxies database requests.</p>

<p>The second axis is confidence. It reflects how sure the handler is that it can return a valid response to the message. In the aforementioned examples, a static handler that doesn't have any assets that can fullfill the request would have a very low confidence, while one that does have available assets would have a high confidence. Likewise, the API endpoint handler would return a high confidence if it had an endpoint that matched the request.</p>

<p>When a handler receives a message that hasn't been evaluated, the handler should return an evaluation response that indicates it's relevance and confidence.</p>

<p>After the bus has received evaluation responses from all of the handlers which initially received the message, it will select one or more <em>winners</em> which will each be passed the message for handling.</p>

<p>Handlers can choose to arbitrarily opt in to receiving a message, or to opt out of consideration.</p>

<p>Everything that opts out has no chance of recieving a message. Everything that opts in will always receive the message (something which may be useful for a logging handler).</p>

<p>All other handlers will be sorted by relevance and confidence, from high to low. The set of potential winners is all of the handlers who have the same highest relevance and confidence.</p>

<p>By default, if there is a tie, the bus picks a handler at random to receive the message. The other options are to just go with whichever handler happens to be first in the list, or to send messages to all handlers.</p>

<h2><a id="thread-safety" class="anchor" href="#thread-safety">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Thread Safety</h2>

<p>The Bus implementation should be thread safe, as should be the CSUUID and SplayTreMap implementations, but there are parts of Crystal that are not currently thread safe, so your mileage may vary.</p>

<p>For instance, it is possible to eke out a little more performance by replacing all of the SplayTreeMap usage with Hash, but under multithreaded conditions, the Hash can exhibit catastrophic failures, particularly in combination with <code>--release</code>. The SplayTreeMap does not exhibit these failures, and future developments with it may make it faster than the Hash for it's intended purpose (as a cache of sorts), so it remains in use.</p>

<h2><a id="installation" class="anchor" href="#installation">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Installation</h2>

<ol><li>Add the dependency to your <code>shard.yml</code>:</li></ol>

<p><code></code>`yaml
   dependencies:</p>

<pre><code class="language-crystal"> bus:
   github: your-github-user/bus</code></pre>

<p><code></code>`</p>

<ol><li>Run <code>shards install</code></li></ol>

<h2><a id="usage" class="anchor" href="#usage">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Usage</h2>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;bus&quot;</span></code></pre>

<p>Create a new Bus.</p>

<pre><code class="language-crystal">bus <span class="o">=</span> <span class="t">Bus</span>.<span class="k">new</span></code></pre>

<p>Create a subclass of Bus::Handler to handle messages.</p>

<pre><code class="language-crystal"><span class="k">class</span> <span class="t">TestHandler</span> <span class="o">&lt;</span> <span class="t">Bus</span><span class="t">::</span><span class="t">Handler</span>
  <span class="t">ResultsChannel</span> <span class="o">=</span> <span class="t">Bus</span><span class="t">::</span><span class="t">Pipeline</span>(<span class="t">Bus</span><span class="t">::</span><span class="t">Message</span>).<span class="k">new</span>(<span class="n">10</span>)

  <span class="k">def</span> <span class="m">handle</span>(msg)
    msg.body <span class="o">&lt;&lt;</span> <span class="s">&quot;Handled by </span><span class="i">#{</span><span class="k">self</span><span class="i">}</span><span class="s">&quot;</span>
    <span class="t">ResultsChannel</span>.send(msg)
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<p>Create a handler instance, and connect it to the bus all in one line.</p>

<pre><code class="language-crystal">handler_1 <span class="o">=</span> <span class="t">TestHandler</span>.<span class="k">new</span>(bus: bus, tags: [<span class="s">&quot;handler&quot;</span>, <span class="s">&quot;handler1&quot;</span>])</code></pre>

<p>Alternatively, do it as separate steps.</p>

<pre><code class="language-crystal">handler_2 <span class="o">=</span> <span class="t">TestHandler</span>.<span class="k">new</span>(tags: [<span class="s">&quot;handler&quot;</span>, <span class="s">&quot;handler2&quot;</span>])
handler_2.subscribe(bus)</code></pre>

<p>Create a message, targetted at all of the handlers with the <code>handler</code> tag.</p>

<pre><code class="language-crystal">message <span class="o">=</span> <span class="t">Bus</span><span class="t">::</span><span class="t">Message</span>.<span class="k">new</span>(
  body: [<span class="s">&quot;One or more&quot;</span>,<span class="s">&quot;Strings of text&quot;</span>],
  tags: [<span class="s">&quot;handler&quot;</span>],
  parameters: {
    <span class="s">&quot;hash&quot;</span> => <span class="s">&quot;of&quot;</span>,
    <span class="s">&quot;arbitrary&quot;</span> => <span class="s">&quot;data&quot;</span>
  }
)</code></pre>

<p>And send it.</p>

<pre><code class="language-crystal">bus.send(message)</code></pre>

<p>Alternatively, do it all from the <code><a href="Bus.html">Bus</a></code>.</p>

<pre><code class="language-crystal">bus.send(
  body: [<span class="s">&quot;One or more&quot;</span>,<span class="s">&quot;Strings of text&quot;</span>],
  tags: [<span class="s">&quot;handler&quot;</span>],
  parameters: {
    <span class="s">&quot;hash&quot;</span> => <span class="s">&quot;of&quot;</span>,
    <span class="s">&quot;arbitrary&quot;</span> => <span class="s">&quot;data&quot;</span>
  }
)</code></pre>

<p>In your handlers, you probably want to implement an <code>#evaluate</code> method to determine relevance and confidence for the handler. The <code>origin</code> on a pipeline is a UUID that uniquely identifies it. When sending an evaluation, the <code>receiver</code> parameter is the origin of the Pipeline that received (and is responding to) the message.</p>

<pre><code class="language-crystal"><span class="k">class</span> <span class="t">TestHandler</span> <span class="o">&lt;</span> <span class="t">Bus</span><span class="t">::</span><span class="t">Handler</span>
  <span class="k">def</span> <span class="m">evaluate</span>(msg)
    ppl <span class="o">=</span> @pipeline

    <span class="k">if</span> will_handle?(msg)
      msg.send_evaluation(
        relevance: <span class="n">0</span>,
        certainty: <span class="n">1000000</span>,
        receiver: ppl.origin
      ) <span class="k">if</span> ppl
    <span class="k">else</span>
      msg.send_evaluation(
        relevance: <span class="n">-1000000</span>,
        certainty: <span class="n">-1000000</span>,
        receiver: ppl.origin
      ) <span class="k">if</span> ppl
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>A handler that has received a message can send a message that will go back to the handler that originally sent the message:</p>

<pre><code class="language-crystal">message.reply(
  body: <span class="s">&quot;Confirmation&quot;</span>,
  parameters: {<span class="s">&quot;timestamp&quot;</span> => <span class="t">Time</span>.local.to_s}
)</code></pre>

<h2><a id="development" class="anchor" href="#development">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Development</h2>

<p><span class="flag orange">TODO</span>  Write development instructions here</p>

<h2><a id="contributing" class="anchor" href="#contributing">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributing</h2>

<ol><li>Fork it (&lt;https://github.com/your-github-user/bus/fork>)</li><li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li><li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li><li>Push to the branch (<code>git push origin my-new-feature</code>)</li><li>Create a new Pull Request</li></ol>

<h2><a id="contributors" class="anchor" href="#contributors">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributors</h2>

<ul><li><a href="https://github.com/your-github-user">Kirk Haines</a> - creator and maintainer</li></ul>

<p><img src="https://img.shields.io/github/languages/code-size/wyhaines/bus.cr?style=for-the-badge" alt="GitHub code size in bytes"/>
<img src="https://img.shields.io/github/issues/wyhaines/bus.cr?style=for-the-badge" alt="GitHub issues"/></p>
</div>
</body>
</html>
